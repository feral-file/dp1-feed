name = "dp1-feed-operator-api"
main = "worker.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Variables for all environments
[vars]
ENVIRONMENT = "local"
SELF_HOSTED_DOMAINS = "localhost:8787"

# KV namespace bindings for storing JSON data
[[kv_namespaces]]
binding = "DP1_PLAYLISTS"
id = "local-playlist-id"

[[kv_namespaces]]
binding = "DP1_PLAYLIST_ITEMS"
id = "local-item-id"

# Queue configuration for async processing
[[queues.producers]]
binding = "DP1_WRITE_QUEUE"
queue = "dp1-write-operations"

[[queues.consumers]]
queue = "dp1-write-operations"
max_batch_size = 1
max_batch_timeout = 1

# Dev environment
[env.dev.vars]
ENVIRONMENT = "development"
SELF_HOSTED_DOMAINS = "dp1-feed-api-dev.dp1.workers.dev"

# KV namespace bindings for storing JSON data
[[env.dev.kv_namespaces]]
binding = "DP1_PLAYLISTS"
id = "dp1-playlists"

[[env.dev.kv_namespaces]]
binding = "DP1_PLAYLIST_ITEMS"
id = "dp1-playlist-items"

# Dev Queue configuration
[[env.dev.queues.producers]]
binding = "DP1_WRITE_QUEUE"
queue = "dp1-write-operations"

[[env.dev.queues.consumers]]
queue = "dp1-write-operations"
max_batch_size = 1
max_batch_timeout = 1

# Production environment
[env.production]
name = "dp1-feed-operator-api-prod"
[env.production.vars]
ENVIRONMENT = "production"
SELF_HOSTED_DOMAINS = "feed.dp1.com, dp1-feed-api-prod.dp1.workers.dev"

# Production KV namespaces
[[env.production.kv_namespaces]]
binding = "DP1_PLAYLISTS"
id = "dp1-playlists"

[[env.production.kv_namespaces]]
binding = "DP1_PLAYLIST_ITEMS"
id = "dp1-playlist-items"

# Production Queue configuration
[[env.production.queues.producers]]
binding = "DP1_WRITE_QUEUE"
queue = "dp1-write-operations-prod"

[[env.production.queues.consumers]]
queue = "dp1-write-operations-prod"
max_batch_size = 5
max_batch_timeout = 2

# Durable Objects (for real-time features - optional)
# [[durable_objects.bindings]]
# name = "PLAYLIST_SESSIONS"
# class_name = "PlaylistSession"

# AI binding (for future AI features - optional)
# [ai]
# binding = "AI"

# Analytics Engine (for usage tracking - optional)
# [[analytics_engine_datasets]]
# binding = "DP1_ANALYTICS"

# Rate limiting configuration
[limits]
cpu_ms = 30000

# Build configuration
[build]
command = "npm run worker:build"

# Secrets (set via wrangler secret put)
# API_SECRET - Bearer token secret
# ED25519_PRIVATE_KEY - Server signing key (REQUIRED)
# IPFS_GATEWAY_TOKEN - IPFS access token (optional) 