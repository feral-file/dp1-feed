name = "dp1-feed-operator-api"
main = "worker.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Variables for all environments
[vars]
ENVIRONMENT = "local"
SELF_HOSTED_DOMAINS = "localhost:8787"
JWT_ISSUER = ""
JWT_AUDIENCE = ""
JWT_PUBLIC_KEY = ""

# CloudFlare KV API credentials for bulk operations
# Note: For local dev with miniflare, these are placeholders - bulk ops will use bindings instead
CLOUDFLARE_ACCOUNT_ID = "local-dev-account"
CLOUDFLARE_PLAYLISTS_NAMESPACE_ID = "local-playlist-id"
CLOUDFLARE_CHANNELS_NAMESPACE_ID = "local-channel-id"
CLOUDFLARE_PLAYLIST_ITEMS_NAMESPACE_ID = "local-item-id"

# KV namespace bindings for storing JSON data
[[kv_namespaces]]
binding = "DP1_PLAYLISTS"
id = "local-playlist-id"

[[kv_namespaces]]
binding = "DP1_CHANNELS"
id = "local-channel-id"

[[kv_namespaces]]
binding = "DP1_PLAYLIST_ITEMS"
id = "local-item-id"

# Queue configuration for async processing
[[queues.producers]]
binding = "DP1_WRITE_QUEUE"
queue = "dp1-write-operations"

[[queues.consumers]]
queue = "dp1-write-operations"
max_batch_size = 1
max_batch_timeout = 1

# Dev environment
[env.dev.vars]
ENVIRONMENT = "development"
SELF_HOSTED_DOMAINS = "dp1-feed-operator-api-dev.autonomy-system.workers.dev"

# CloudFlare KV API credentials for bulk operations
CLOUDFLARE_ACCOUNT_ID = "ef12e2e53d135e51a45afab861740134"
CLOUDFLARE_PLAYLISTS_NAMESPACE_ID = "1da79f6f0f914529858468874d4834a2"
CLOUDFLARE_CHANNELS_NAMESPACE_ID = "7a34bb7347e54236b107f9077416c5ba"
CLOUDFLARE_PLAYLIST_ITEMS_NAMESPACE_ID = "796f0a4b1e7541f48df8e0d744c77b98"

JWT_PUBLIC_KEY = """
-----BEGIN PUBLIC KEY-----
MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAoKSzYr0c93zbx63XCNDI
hvbYE116GSdwxK/grvr7VGx75CA9ZCWi4jtLkFFGuI1AqNE7lau6ENr2rjVYgfqh
clszDxRTOWbA0WYP+FbYqzu2+tilXEPqLMixXWOtB4+F3IY1RfkxA30UwB+9CXru
6waPJQRuiNTgu40wHxj0yyCThgWiT2UqVBf8CJf3cdsx5PYIqdwQZHByx5d7YVA/
V16peuxI1Qy7BRpWGD5UG2Orj2cXXrtb1hn+BKyA0okY1ljilDCmudBjA8pf2w8w
DV8BcU8dVXD4LaLN2YkA81T13c4hRJUJok3ZHJWSxEzzNTFQGxzBw1Cz3Boez9cB
qHwhccezI3rkltzG/ojAaIrfBzelUdm5wJ5aharpTeSBF55hFjyCnGWtUITlOYF8
XLaCfEviPS/KJ454sWftE2XlDmRl6ewhOBs9Qg3aae8CFTeyFLJJ8G8WSPLlNPx5
bFXAmxMgEbwi1TnsnbQp0mIHW/GXy79kIy9duQkBpX0hHdvpDzOH5e/0pjQBkDeM
g5QwI/OAEXES4aEonMEdKU2lfsqIHcbQK4LzbFPX2MMGwaLtJtbWSp4rlTrSB7Yv
mzHjaijSQx8gzSqcnJL72eaVTZKendCytzQ4HP3m86OxU+KE6qM/QsaBEXV2eCZf
cTXRi8UsShqst62rlrwOXnsCAwEAAQ==
-----END PUBLIC KEY-----
"""

# KV namespace bindings for storing JSON data
[[env.dev.kv_namespaces]]
binding = "DP1_PLAYLISTS"
id = "1da79f6f0f914529858468874d4834a2"

[[env.dev.kv_namespaces]]
binding = "DP1_CHANNELS"
id = "7a34bb7347e54236b107f9077416c5ba"

[[env.dev.kv_namespaces]]
binding = "DP1_PLAYLIST_ITEMS"
id = "796f0a4b1e7541f48df8e0d744c77b98"

# Dev Queue configuration
[[env.dev.queues.producers]]
binding = "DP1_WRITE_QUEUE"
queue = "dp1-write-operations"

[[env.dev.queues.consumers]]
queue = "dp1-write-operations"
max_batch_size = 1
max_batch_timeout = 1

# Production environment
[env.production]
name = "dp1-feed-operator-api-prod"
[env.production.vars]
ENVIRONMENT = "production"
SELF_HOSTED_DOMAINS = "feed.feralfile.com, dp1-feed-operator-api-prod.autonomy-system.workers.dev"

# CloudFlare KV API credentials for bulk operations
CLOUDFLARE_ACCOUNT_ID = "ef12e2e53d135e51a45afab861740134"
CLOUDFLARE_PLAYLISTS_NAMESPACE_ID = "d8dd2c9576964fd4832fd16dd3feceb8"
CLOUDFLARE_CHANNELS_NAMESPACE_ID = "99d0a95fdb844df6bd01e688c014be26"
CLOUDFLARE_PLAYLIST_ITEMS_NAMESPACE_ID = "97e0151430994b37b443eda4260f07d7"

JWT_PUBLIC_KEY = """
-----BEGIN PUBLIC KEY-----
MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAs/tBze5kS9ca6Wa2ei8z
WpK+uQivJdMui9AThzK8TACDmvD2+0D50HotOJOeYOVbaqcZsHGq0lNENkBydFBB
4FtDFqMQnXxO6hp7sNktkj2XwcZO0ZcoMnFHN/To5BENYnAMo4hWWBiNgFonckYy
edqp2ZznigFdxYzfwVjns5EujAuCTpG4Al4BFZgQbVMucPYIV4x7PyzspFlURG8f
Lzj14P65Y17gNxAy58TX0BFBYKrkOscTEvcqSvYHkK71JvtkRPh1EXtNcVGY2vG2
omwdwUOJTTcLajirbzx658VVzNsipwRBnWBgvsdNFYlnSimnmlCUVOZ8jGA4dmlE
i2cU8f6PpsNELzQiCuEghYAGqVX1IFybXJ5Hzm7LTg68VtvHI8d5b8RsfFVNEmMP
OlwM087uwwpRjunuGGD0mNv/gd10nwmp28r3Wn5ll0XfsVc7qB3HZFKC5M/3kdd8
59Ad5e3GNMH7U864liCJmXitxXJOYwooZ/n+K9ZMzAFaFyH22rVZP0lqxJhRKD6a
RUjTEd1AM3ZxzteMPIEYxwqoO/L7Mw0g2ikBCUanPm2KmYJQt7SBxToR7slB6zZX
4EksVVCJTa/9e0zJRqsCOcNVm1v3ThFY669b2IoS78DWi7gyZ6B6ucpfqiNX3uNl
31Y7fRwBZIYhxUdzFeABb9kCAwEAAQ==
-----END PUBLIC KEY-----
"""

# Production KV namespaces
[[env.production.kv_namespaces]]
binding = "DP1_PLAYLISTS"
id = "d8dd2c9576964fd4832fd16dd3feceb8"

[[env.production.kv_namespaces]]
binding = "DP1_CHANNELS"
id = "99d0a95fdb844df6bd01e688c014be26"

[[env.production.kv_namespaces]]
binding = "DP1_PLAYLIST_ITEMS"
id = "97e0151430994b37b443eda4260f07d7"

# Production Queue configuration
[[env.production.queues.producers]]
binding = "DP1_WRITE_QUEUE"
queue = "dp1-write-operations-prod"

[[env.production.queues.consumers]]
queue = "dp1-write-operations-prod"
max_batch_size = 5
max_batch_timeout = 2

# Durable Objects (for real-time features - optional)
# [[durable_objects.bindings]]
# name = "PLAYLIST_SESSIONS"
# class_name = "PlaylistSession"

# AI binding (for future AI features - optional)
# [ai]
# binding = "AI"

# Analytics Engine (for usage tracking - optional)
# [[analytics_engine_datasets]]
# binding = "DP1_ANALYTICS"

# Rate limiting configuration
[limits]
cpu_ms = 30000

# Build configuration
[build]
command = "npm run worker:build"

# Secrets (set via wrangler secret put)
# API_SECRET - Bearer token secret for API authentication
# ED25519_PRIVATE_KEY - Server signing key (REQUIRED)
# CLOUDFLARE_API_TOKEN - Cloudflare API token for bulk KV operations (REQUIRED for dev/prod, optional for local)
#   Create at: https://dash.cloudflare.com/profile/api-tokens
#   Required permissions: Account.Workers KV Storage:Edit
#   Local dev: Not needed - bulk operations will use KV bindings instead
# IPFS_GATEWAY_TOKEN - IPFS access token (optional) 